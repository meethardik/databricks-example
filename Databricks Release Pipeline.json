{"source":2,"revision":15,"description":null,"createdBy":{"displayName":"Beda Tse","url":"https://app.vssps.visualstudio.com/A3470f2f6-283a-4f0e-a677-5851315cd68a/_apis/Identities/2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","_links":{"avatar":{"href":"https://dev.azure.com/bedatse/_apis/GraphProfile/MemberAvatars/aad.MmMzZTdiOGUtZjI4Mi03Yjk4LWE5YjAtY2EyYzgyZTMyMWQ4"}},"id":"2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","uniqueName":"beda@coeushk.onmicrosoft.com","imageUrl":"https://dev.azure.com/bedatse/_api/_common/identityImage?id=2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","descriptor":"aad.MmMzZTdiOGUtZjI4Mi03Yjk4LWE5YjAtY2EyYzgyZTMyMWQ4"},"createdOn":"2019-02-10T07:25:26.580Z","modifiedBy":{"displayName":"Beda Tse","url":"https://app.vssps.visualstudio.com/A3470f2f6-283a-4f0e-a677-5851315cd68a/_apis/Identities/2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","_links":{"avatar":{"href":"https://dev.azure.com/bedatse/_apis/GraphProfile/MemberAvatars/aad.MmMzZTdiOGUtZjI4Mi03Yjk4LWE5YjAtY2EyYzgyZTMyMWQ4"}},"id":"2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","uniqueName":"beda@coeushk.onmicrosoft.com","imageUrl":"https://dev.azure.com/bedatse/_api/_common/identityImage?id=2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","descriptor":"aad.MmMzZTdiOGUtZjI4Mi03Yjk4LWE5YjAtY2EyYzgyZTMyMWQ4"},"modifiedOn":"2019-02-28T15:34:01.280Z","isDeleted":false,"variables":{},"variableGroups":[2],"environments":[{"id":2,"name":"Dev Environment","rank":1,"owner":{"displayName":"Beda Tse","url":"https://app.vssps.visualstudio.com/A3470f2f6-283a-4f0e-a677-5851315cd68a/_apis/Identities/2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","_links":{"avatar":{"href":"https://dev.azure.com/bedatse/_apis/GraphProfile/MemberAvatars/aad.MmMzZTdiOGUtZjI4Mi03Yjk4LWE5YjAtY2EyYzgyZTMyMWQ4"}},"id":"2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","uniqueName":"beda@coeushk.onmicrosoft.com","imageUrl":"https://dev.azure.com/bedatse/_api/_common/identityImage?id=2c3e7b8e-f282-6b98-a9b0-ca2c82e321d8","descriptor":"aad.MmMzZTdiOGUtZjI4Mi03Yjk4LWE5YjAtY2EyYzgyZTMyMWQ4"},"variables":{},"variableGroups":[1,4],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":4}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":5},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":6}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":6,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"33c63b11-352b-45a2-ba1b-54cb568a29ca","version":"0.*","name":"Use Python 3.x","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"versionSpec":"3.x","addToPath":"true","architecture":"x64"}},{"environment":{},"taskId":"94a74903-f93f-4075-884f-dc11f34058b4","version":"2.*","name":"Create Databricks Resource Group","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceName":"cd49f2bc-1d47-439c-b0fa-c16c2c04f43e","action":"Create Or Update Resource Group","resourceGroupName":"$(rg_groupname)","location":"$(rg_location)","templateLocation":"Linked artifact","csmFileLink":"","csmParametersFileLink":"","csmFile":"$(System.DefaultWorkingDirectory)/_databricks-example/arm_template/template.json","csmParametersFile":"$(System.DefaultWorkingDirectory)/_databricks-example/arm_template/parameters.json","overrideParameters":"-keyvaultName \"$(keyvault_name)\" -keyvaultLocation \"$(databricks_location)\" -workspaceName \"$(databricks_name)\" -workspaceLocation \"$(databricks_location)\" -tier \"standard\" -sku \"Standard\" -tenant \"$(tenant_id)\" -enabledForDeployment false -enabledForTemplateDeployment true -enabledForDiskEncryption false -networkAcls {\"defaultAction\":\"Allow\",\"bypass\":\"AzureServices\",\"virtualNetworkRules\":[],\"ipRules\":[]}","deploymentMode":"Incremental","enableDeploymentPrerequisites":"None","deploymentGroupEndpoint":"","project":"","deploymentGroupName":"","copyAzureVMTags":"true","runAgentServiceAsUser":"false","userName":"","password":"","outputVariable":"","deploymentName":"","deploymentOutputs":"","addSpnToEnvironment":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Install Tools","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"python -m pip install --upgrade pip setuptools wheel databricks-cli","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Authenticate with Databricks CLI","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"databricks configure --token <<EOF\nhttps://$(databricks_location).azuredatabricks.net\n$(databricks-token)\nEOF","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Upload Notebook to Databricks","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"databricks workspace mkdirs /build\ndatabricks workspace import --language PYTHON --format SOURCE --overwrite _databricks-example/notebook/$(notebook_name)-$(Build.SourceVersion).py /build/$(notebook_name)-$(Build.SourceVersion).py","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Create Notebook Run JSON","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Replace run name and deployment notebook path\ncat _databricks-example/notebook/notebook-run.json.tmpl | jq '.run_name = \"Test Run - $(Build.SourceVersion)\" | .notebook_task.notebook_path = \"/build/$(notebook_name)-$(Build.SourceVersion).py\"' > $(notebook_name)-$(Build.SourceVersion).run.json\n\n# Check the Content of the generated execution file\ncat $(notebook_name)-$(Build.SourceVersion).run.json","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Run Notebook on Databricks","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"echo \"##vso[task.setvariable variable=RunId; isOutput=true;]`databricks runs submit --json-file $(notebook_name)-$(Build.SourceVersion).run.json | jq -r .run_id`\"","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Wait for Databricks Run to complete","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"echo \"Run Id: $(RunId)\"\n\n# Wait until job run finish\nwhile [ \"`databricks runs get --run-id $(RunId) | jq -r '.state.life_cycle_state'`\" != \"INTERNAL_ERROR\" ] && [ \"`databricks runs get --run-id $(RunId) | jq -r '.state.result_state'`\" == \"null\" ]\ndo \necho \"Waiting for Databrick job run $(RunId) to complete, sleep for 30 seconds\"\nsleep 30\ndone\n\n# Print Run Results\ndatabricks runs get --run-id $(RunId)\n\n# If not success, report failure to Azure DevOps\nif [ \"`databricks runs get --run-id $(RunId) | jq -r '.state.result_state'`\" != \"SUCCESS\" ]\nthen\necho \"##vso[task.complete result=Failed;]Failed\"\nfi","workingDirectory":"","failOnStderr":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":15,"url":"https://vsrm.dev.azure.com/bedatse/a6a94ff6-dfe6-47a6-925d-73661008d946/_apis/Release/releases/15","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/bedatse/_apis/public/Release/badge/a6a94ff6-dfe6-47a6-925d-73661008d946/2/2"}],"artifacts":[{"sourceId":"a6a94ff6-dfe6-47a6-925d-73661008d946:5","type":"Build","alias":"_databricks-example","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://dev.azure.com/bedatse/_permalink/_build/index?collectionId=501a31ba-faf8-4d7a-8018-5c158ccc2c8b&projectId=a6a94ff6-dfe6-47a6-925d-73661008d946&definitionId=5","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"latestType","name":"Latest"},"definition":{"id":"5","name":"databricks-example"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"a6a94ff6-dfe6-47a6-925d-73661008d946","name":"azure-dataops"},"repository":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[{"artifactAlias":"_databricks-example","triggerConditions":[{"sourceBranch":"","tags":[],"useBuildDefinitionBranch":true,"createReleaseOnBuildTagging":false}],"triggerType":1}],"releaseNameFormat":"Release-$(rev:r)","tags":[],"pipelineProcess":{"type":1},"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"Other"}},"id":2,"name":"Databricks Release Pipeline","path":"\\","projectReference":null,"url":"https://vsrm.dev.azure.com/bedatse/a6a94ff6-dfe6-47a6-925d-73661008d946/_apis/Release/definitions/2","_links":{"self":{"href":"https://vsrm.dev.azure.com/bedatse/a6a94ff6-dfe6-47a6-925d-73661008d946/_apis/Release/definitions/2"},"web":{"href":"https://dev.azure.com/bedatse/a6a94ff6-dfe6-47a6-925d-73661008d946/_release?definitionId=2"}}}